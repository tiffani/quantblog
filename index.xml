<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Musings</title>
<link>https://tiffani.dev/</link>
<atom:link href="https://tiffani.dev/index.xml" rel="self" type="application/rss+xml"/>
<description>A place where I learn...</description>
<generator>quarto-1.8.25</generator>
<lastBuildDate>Thu, 06 Nov 2025 05:00:00 GMT</lastBuildDate>
<item>
  <title>On Volatility-Driven Trailing Stops - Chandelier Stops via the Interactive Brokers API</title>
  <dc:creator>Tiffani Ashley Bell</dc:creator>
  <link>https://tiffani.dev/posts/on-volatility-driven-stops-chandelier-stops-in-ibkr/</link>
  <description><![CDATA[ 





<section id="cut-your-losses-let-your-gains-run-just-not-away" class="level3">
<h3 class="anchored" data-anchor-id="cut-your-losses-let-your-gains-run-just-not-away">“Cut your losses, let your gains run…” (just not <em>away</em>)</h3>
<p>Having a better methodology for stops and capturing unrealized gains became super important after a certain set of recent disappointing trades. Goldman ran up to an all-time-high of $825.25 ahead of a Jerome Powell speech on September 22, 2025. The positions I held at that point were the result of a few days of analysis, familiarizing myself with more of the statistical properties of the things I am trading—especially in tandem with working through the Quantitative Methods book for the <a href="https://www.cfainstitute.org">CFA</a> exam in February 2026.</p>
<p>I did a five-year analysis of Goldman’s daily returns dating back to January 2020. They showed 2.36 excess kurtosis and positive skew. In English, that is a stock that has small losses here and there, but a few very large gains. This was a very large gain…and yet I did not capture enough of this move.</p>
<p>I experienced a gain of 584.8% on a GS Oct 2026 800 call after GS rocketed to that all-time-high. Unfortunately, my stop did not hug this position tightly enough and in the subsequent drop gave back nearly half those gains. This was sad and preventable!</p>
</section>
<section id="what-is-a-chandelier-stop" class="level3">
<h3 class="anchored" data-anchor-id="what-is-a-chandelier-stop">What is a “chandelier stop”?</h3>
<p>Interactive Brokers’s Trader Workstation offers trailing stops. They are fixed, however. You can set a percentage or a fixed value for the stop. But, then you must through the rigamarole of determining what percentage or absolute value to use. And even after you do that, though, that’s it. The parameter you set for how wide (permissive) or how narrow (restrictive) your trailing stop is doesn’t change.</p>
<p>I have been wanting to understand if having a stop that adjusts dynamically based on an underlying’s volatility made sense. And hey! It turns out this exists and it is called a <strong>chandelier stop</strong>. I first read about this in Dr.&nbsp;Alexander Elder’s <em>Come Into My Trading Room</em>. <strong>It uses the average true range of an underlying to turn volatility into a way to determine where stops should go.</strong></p>
<p>A chandelier stop is set with volatility in mind and may retreat as prices move around. This is basically the mechanical embodiment of <em>breathing room</em>. It can be used for both entries and exits.</p>
<p>As Elder says</p>
<blockquote class="blockquote">
<p>When traders are long, it hangs their stops from the highest peak reached by that trend, like a chandelier hangs from the tallest point in the room. As prices move up, the Chadelier Exit, suspended from the highest point of that trend, also rises. It tracks volatility as well as prices, as its distance from the peak grows with the rise in volatility. […] There is no telling how high a trend may go, and a Chandelier will rise until prices peel off from the ceiling and hit that stop.</p>
</blockquote>
<p>How much breathing room it has is, of course, the product of the parameters used to create the stop. The chandelier stop consists of a lookback period and the average true range (both to calculate volatility).</p>
</section>
<section id="working-with-interactive-brokerss-api-v10.37" class="level3">
<h3 class="anchored" data-anchor-id="working-with-interactive-brokerss-api-v10.37">Working with Interactive Brokers’s API (v10.37+)</h3>
<p>What’s nice is that Interactive Brokers has an API and <a href="https://www.interactivebrokers.com/campus/ibkr-quant-news/interactive-brokers-python-api-native-a-step-by-step-guide/">Python</a> libraries for programmatically interacting with your trading account. The APIs are extensive and take some effort to understand, though. (Some things are not documented very well, others are not documented at all unless you’ve joined a mailing list for support.) Once you get everything running, it is nothing to then start putting on and managing trades via Python—including creating a chandelier stop to manage a long call position that is in the green!</p>
<p>The code below uses Interactive Brokers’s Python library <code>ibapi</code> version 10.37 to execute trades using IBGateway version 10.37 starting in October 2025.</p>
<p>This works, but is also still a work in progress.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>ibkr-chandelier.py</strong></pre>
</div>
<div class="sourceCode" id="cb1" data-filename="ibkr-chandelier.py" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Written to accommodate IBApi libraries 10.30 or above.</span></span>
<span id="cb1-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Also built this using 10.37 version of IBGateway.</span></span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> time</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> datetime</span>
<span id="cb1-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> threading</span>
<span id="cb1-8"></span>
<span id="cb1-9"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb1-10"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> yfinance <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> yf</span>
<span id="cb1-11"></span>
<span id="cb1-12"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> ibapi.client <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb1-13"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> ibapi.wrapper <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb1-14"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> ibapi.contract <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb1-15"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> ibapi.utils <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> iswrapper</span>
<span id="cb1-16"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> ibapi.ticktype <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> TickTypeEnum</span>
<span id="cb1-17"></span>
<span id="cb1-18"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> decimal <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Decimal, ROUND_CEILING</span>
<span id="cb1-19"></span>
<span id="cb1-20">ATR_MULTIPLIER <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 3x ATR for stocks, 3-4x for options</span></span>
<span id="cb1-21">ATR_PERIOD <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Standard ATR period</span></span>
<span id="cb1-22">LOOKBACK_PERIOD <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Days to look back for highest high</span></span>
<span id="cb1-23"></span>
<span id="cb1-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Need to round to next nickel to accommodate minimum order tick sizes</span></span>
<span id="cb1-25"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> round_to_nickel(price):</span>
<span id="cb1-26">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>((Decimal(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(price)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> Decimal(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'0.05'</span>)).quantize(Decimal(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'1'</span>), rounding <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ROUND_CEILING) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> Decimal(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'0.05'</span>))</span>
<span id="cb1-27"></span>
<span id="cb1-28"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> ChandelierStopManager:</span>
<span id="cb1-29">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, ibkr_client, ibkr_account):</span>
<span id="cb1-30">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.ibkr_client <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ibkr_client</span>
<span id="cb1-31">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.ibkr_account <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ibkr_account</span>
<span id="cb1-32"></span>
<span id="cb1-33">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _cancel_existing_stops(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, ticker):</span>
<span id="cb1-34">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Cancel existing stop orders for a ticker</span></span>
<span id="cb1-35">        open_orders <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.ib.openTrades()</span>
<span id="cb1-36">        </span>
<span id="cb1-37">        cancelled_count <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb1-38">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> trade <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> open_orders:</span>
<span id="cb1-39">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (trade.contract.symbol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> ticker <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> trade.order.orderType <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'STP'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'TRAIL'</span>]):</span>
<span id="cb1-40">                <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.ibkr_client.cancelOrder(trade.order)</span>
<span id="cb1-41">                cancelled_count <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-42">        </span>
<span id="cb1-43">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> cancelled_count <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb1-44">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  Cancelled </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> cancelled_count <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> existing stop order(s) ..."</span>)</span>
<span id="cb1-45"></span>
<span id="cb1-46"></span>
<span id="cb1-47">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate a chandelier stop for a given ticker</span></span>
<span id="cb1-48">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> calculate_chandelier_stop(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, ticker, multiplier <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ATR_MULTIPLIER, period <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ATR_PERIOD):</span>
<span id="cb1-49">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Calculating Chandelier Stop for </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> ticker <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">..."</span>)</span>
<span id="cb1-50">        </span>
<span id="cb1-51">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Download recent price data</span></span>
<span id="cb1-52">        data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> yf.download(ticker, period <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2mo'</span>, interval <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'1d'</span>, progress <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb1-53">        </span>
<span id="cb1-54">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> data.empty:</span>
<span id="cb1-55">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Yikes: Could not download data for </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> ticker <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> ..."</span>)</span>
<span id="cb1-56">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb1-57">        </span>
<span id="cb1-58">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate True Range components</span></span>
<span id="cb1-59">        high_low <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'High'</span>][ticker] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Low'</span>][ticker])</span>
<span id="cb1-60">        high_close <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">abs</span>(data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'High'</span>][ticker] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Close'</span>][ticker].shift())</span>
<span id="cb1-61">        low_close <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">abs</span>(data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Low'</span>][ticker] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Close'</span>][ticker].shift())</span>
<span id="cb1-62">        </span>
<span id="cb1-63">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># True Range = max of the three</span></span>
<span id="cb1-64">        true_range <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.concat([high_low, high_close, low_close], axis <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(axis <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb1-65">        </span>
<span id="cb1-66">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Average True Range (ATR)</span></span>
<span id="cb1-67">        atr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> true_range.rolling(period).mean()</span>
<span id="cb1-68">        current_atr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> atr.iloc[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb1-69">        </span>
<span id="cb1-70">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Current price and highest high</span></span>
<span id="cb1-71">        current_price <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Close'</span>][ticker].iloc[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb1-72">        highest_high <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'High'</span>][ticker].tail(period).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>()</span>
<span id="cb1-73">        </span>
<span id="cb1-74">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Chandelier Stop = Highest High - (Multiplier × ATR)</span></span>
<span id="cb1-75">        stop_level <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> round_to_nickel(highest_high <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> (multiplier <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> current_atr))</span>
<span id="cb1-76">        </span>
<span id="cb1-77">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate distance to stop as percentage</span></span>
<span id="cb1-78">        distance_pct <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ((current_price <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> stop_level) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> current_price) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span></span>
<span id="cb1-79">        </span>
<span id="cb1-80">        result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb1-81">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ticker'</span>: ticker,</span>
<span id="cb1-82">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'current_price'</span>: current_price,</span>
<span id="cb1-83">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'atr'</span>: current_atr,</span>
<span id="cb1-84">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'highest_high'</span>: highest_high,</span>
<span id="cb1-85">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'stop_level'</span>: stop_level,</span>
<span id="cb1-86">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'distance_pct'</span>: distance_pct,</span>
<span id="cb1-87">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'timestamp'</span>: datetime.datetime.now()</span>
<span id="cb1-88">        }</span>
<span id="cb1-89">        </span>
<span id="cb1-90">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Print results</span></span>
<span id="cb1-91">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'='</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb1-92">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Ticker: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> ticker <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb1-93">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Current Price: $</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> current_price<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb1-94">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"ATR (</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> period <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">): $</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> current_atr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb1-95">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Highest High (</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> period <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">d): $</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> highest_high<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb1-96">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Chandelier Stop: $</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> stop_level<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb1-97">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Distance to Stop: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> distance_pct<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">%"</span>)</span>
<span id="cb1-98">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'='</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb1-99">        </span>
<span id="cb1-100">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> result</span>
<span id="cb1-101">    </span>
<span id="cb1-102">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate and update Chandelier stops for all open positions</span></span>
<span id="cb1-103">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> update_stops_for_all_positions(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, multiplier <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ATR_MULTIPLIER):</span>
<span id="cb1-104">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.ibkr_client.connected:</span>
<span id="cb1-105">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Ooopps! You're not connected to IBKR..."</span>)</span>
<span id="cb1-106">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span></span>
<span id="cb1-107">            </span>
<span id="cb1-108">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.ibkr_client.reqPositions()</span>
<span id="cb1-109"></span>
<span id="cb1-110">        time.sleep(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb1-111"></span>
<span id="cb1-112">        positions <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.ibkr_client.positions</span>
<span id="cb1-113">            </span>
<span id="cb1-114">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> positions:</span>
<span id="cb1-115">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">No positions to update"</span>)</span>
<span id="cb1-116">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span></span>
<span id="cb1-117">            </span>
<span id="cb1-118">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'='</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">70</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb1-119">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UPDATING CHANDELIER STOPS..."</span>)</span>
<span id="cb1-120">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'='</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">70</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb1-121">            </span>
<span id="cb1-122">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> position <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> positions:</span>
<span id="cb1-123">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> position[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Only for long positions</span></span>
<span id="cb1-124">                ticker <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> position[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].symbol</span>
<span id="cb1-125">                quantity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> position[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb1-126">                    </span>
<span id="cb1-127">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">--- Processing </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> ticker <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> ---"</span>)</span>
<span id="cb1-128">                    </span>
<span id="cb1-129">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate Chandelier stop level</span></span>
<span id="cb1-130">                stop_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.calculate_chandelier_stop(ticker, multiplier)</span>
<span id="cb1-131">                    </span>
<span id="cb1-132">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> stop_data <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb1-133">                    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Skipping </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> ticker <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> - could not calculate stop ..."</span>)</span>
<span id="cb1-134">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">continue</span></span>
<span id="cb1-135">                    </span>
<span id="cb1-136">                stop_level <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stop_data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'stop_level'</span>]</span>
<span id="cb1-137">                    </span>
<span id="cb1-138">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Cancel any existing stop orders for this position</span></span>
<span id="cb1-139">                <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._cancel_existing_stops(ticker)</span>
<span id="cb1-140">                    </span>
<span id="cb1-141">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Place new stop order</span></span>
<span id="cb1-142">                <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._place_stop_order(position[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], quantity, stop_level)</span>
<span id="cb1-143"></span>
<span id="cb1-144">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _cancel_existing_stops(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, ticker):</span>
<span id="cb1-145">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Cancel existing stop orders for a ticker</span></span>
<span id="cb1-146">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.ibkr_client.reqAllOpenOrders()</span>
<span id="cb1-147"></span>
<span id="cb1-148">        time.sleep(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb1-149">            </span>
<span id="cb1-150">        cancelled_count <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb1-151">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> trade <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.ibkr_client.open_orders:</span>
<span id="cb1-152">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (trade[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].symbol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> ticker <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> trade[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>].orderType <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'STP'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'TRAIL'</span>]):</span>
<span id="cb1-153">                <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.ibkr_client.cancelOrder(trade[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], OrderCancel())</span>
<span id="cb1-154">                cancelled_count <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-155">            </span>
<span id="cb1-156">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> cancelled_count <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb1-157">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  Cancelled </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> cancelled_count <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> existing stop order(s) ..."</span>)</span>
<span id="cb1-158"></span>
<span id="cb1-159">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _place_stop_order(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, contract, quantity, stop_price):</span>
<span id="cb1-160">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Place a stop-loss order</span></span>
<span id="cb1-161">        order <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Order()</span>
<span id="cb1-162">        order.action <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'SELL'</span></span>
<span id="cb1-163">        order.orderType <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'STP'</span></span>
<span id="cb1-164">        order.totalQuantity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> quantity</span>
<span id="cb1-165">        order.auxPrice <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stop_price  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Stop trigger price</span></span>
<span id="cb1-166">        order.account <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.ibkr_account</span>
<span id="cb1-167">        order.tif <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'GTC'</span></span>
<span id="cb1-168"></span>
<span id="cb1-169">        contract.exchange <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'SMART'</span></span>
<span id="cb1-170">            </span>
<span id="cb1-171">        oid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.ibkr_client.nextId()</span>
<span id="cb1-172"></span>
<span id="cb1-173">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Place the order</span></span>
<span id="cb1-174">        trade <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.ibkr_client.placeOrder(oid, contract, order)</span>
<span id="cb1-175">            </span>
<span id="cb1-176">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  ✓ Placed stop order at $</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> stop_price<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb1-177">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"    Quantity: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> quantity <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb1-178">            </span>
<span id="cb1-179">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> trade</span>
<span id="cb1-180"></span>
<span id="cb1-181"></span>
<span id="cb1-182"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># This is set up to serve as the client and the wrapper</span></span>
<span id="cb1-183"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> IBApiClient(EWrapper, EClient):</span>
<span id="cb1-184">    IBKR_GATEWAY_ADDRESS <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'127.0.0.1'</span></span>
<span id="cb1-185">    IBKR_TESTING_PORT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4002</span></span>
<span id="cb1-186">    IBKR_LIVE_PORT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4001</span></span>
<span id="cb1-187"></span>
<span id="cb1-188">    LIVE_DATA <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-189">    FROZEN_DATA <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> </span>
<span id="cb1-190">    DELAYED_DATA <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb1-191">    FROZEN_DELAYED_DATA <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb1-192"></span>
<span id="cb1-193">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, address, port, client_id):</span>
<span id="cb1-194">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Getting started with IBKR..."</span>)</span>
<span id="cb1-195">        EClient.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>)</span>
<span id="cb1-196">        EWrapper.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>)</span>
<span id="cb1-197">                </span>
<span id="cb1-198">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Establish the connection to TWS/IB Gateway</span></span>
<span id="cb1-199">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># TWS supports up to 32 simultaneous client connections</span></span>
<span id="cb1-200">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.<span class="ex" style="color: null;
background-color: null;
font-style: inherit;">connect</span>(address, port, client_id)</span>
<span id="cb1-201">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.connected <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb1-202">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.positions <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb1-203">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.open_orders <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb1-204"></span>
<span id="cb1-205">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Launch the client thread</span></span>
<span id="cb1-206">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The 'run' function executes in a loop that repeats as long</span></span>
<span id="cb1-207">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># as the client is connected.</span></span>
<span id="cb1-208">        thread <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> threading.Thread(target <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.run)</span>
<span id="cb1-209">        thread.start()</span>
<span id="cb1-210"></span>
<span id="cb1-211">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@iswrapper</span></span>
<span id="cb1-212">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> nextValidId(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, orderId):</span>
<span id="cb1-213">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.orderId <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> orderId</span>
<span id="cb1-214"></span>
<span id="cb1-215">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@iswrapper</span></span>
<span id="cb1-216">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> nextId(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb1-217">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.orderId <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> </span>
<span id="cb1-218">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.orderId</span>
<span id="cb1-219">    </span>
<span id="cb1-220">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@iswrapper</span></span>
<span id="cb1-221">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> currentTime(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, current_time):</span>
<span id="cb1-222">        t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> datetime.datetime.fromtimestamp(current_time)</span>
<span id="cb1-223">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'Current time: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> t <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb1-224"></span>
<span id="cb1-225">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@iswrapper</span></span>
<span id="cb1-226">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> contractDetails(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, request_id, contractDetails):</span>
<span id="cb1-227">        attrs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">vars</span>(contractDetails)</span>
<span id="cb1-228">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>.join(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> name <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> value <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> name, value <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> attrs.items()))</span>
<span id="cb1-229"></span>
<span id="cb1-230">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@iswrapper</span></span>
<span id="cb1-231">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> contractDetailsEnd(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, reqId):</span>
<span id="cb1-232">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">super</span>().contractDetailsEnd(reqId)</span>
<span id="cb1-233"></span>
<span id="cb1-234">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@iswrapper</span></span>
<span id="cb1-235">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> historicalData(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, request_id, bar):</span>
<span id="cb1-236">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(bar)</span>
<span id="cb1-237">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">super</span>().historicalData(request_id, bar)</span>
<span id="cb1-238">    </span>
<span id="cb1-239">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@iswrapper</span></span>
<span id="cb1-240">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> historicalDataEnd(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, reqId, start, end):</span>
<span id="cb1-241">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Historical data ended for </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> reqId <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">. Started at </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> start <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, ending at </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> end <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb1-242">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">super</span>().historicalDataEnd(reqId, start, end)</span>
<span id="cb1-243"></span>
<span id="cb1-244">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@iswrapper</span></span>
<span id="cb1-245">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> error(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, reqId, errorCode, errorString, advancedOrderRejectJson <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>):</span>
<span id="cb1-246">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'Error: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> errorCode <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> errorString <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb1-247">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">super</span>().error(reqId, errorCode, errorString, advancedOrderRejectJson)</span>
<span id="cb1-248">    </span>
<span id="cb1-249">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@iswrapper</span></span>
<span id="cb1-250">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> tickPrice(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, reqId, tickType, price, attrib):</span>
<span id="cb1-251">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Request ID: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> reqId <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, tickType: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> TickTypeEnum<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>to_str(tickType) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, price: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> price <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, attrib: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> attrib <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb1-252"></span>
<span id="cb1-253">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@iswrapper</span></span>
<span id="cb1-254">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> tickSize(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, reqId, tickType, size):</span>
<span id="cb1-255">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Request ID: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> reqId <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, tickType: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> TickTypeEnum<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>to_str(tickType)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, size: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> size <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb1-256"></span>
<span id="cb1-257">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@iswrapper</span></span>
<span id="cb1-258">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> tickString(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, request_id, tickType, value):</span>
<span id="cb1-259">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Request ID: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> request_id <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, tickType: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> TickTypeEnum<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>to_str(tickType) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, value: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> value <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb1-260"></span>
<span id="cb1-261">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@iswrapper</span></span>
<span id="cb1-262">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> accountSummary(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, reqId, account, tag, value, currency):</span>
<span id="cb1-263">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">super</span>().accountSummary(reqId, account, tag, value, currency)</span>
<span id="cb1-264">    </span>
<span id="cb1-265">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@iswrapper</span></span>
<span id="cb1-266">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> updatePortfolio(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, contract: Contract, position: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>, marketPrice: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>, marketValue: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>, averageCost: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>, unrealizedPNL: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>, realizedPNL: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>, accountName: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>):</span>
<span id="cb1-267">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UpdatePortfolio."</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Symbol:"</span>, contract.symbol, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SecType:"</span>, contract.secType, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Exchange:"</span>, contract.exchange, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Position:"</span>, position, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"MarketPrice:"</span>, marketPrice, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"MarketValue:"</span>, marketValue, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AverageCost:"</span>, averageCost, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UnrealizedPNL:"</span>, unrealizedPNL, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RealizedPNL:"</span>, realizedPNL, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AccountName:"</span>, accountName)</span>
<span id="cb1-268">        </span>
<span id="cb1-269">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@iswrapper</span></span>
<span id="cb1-270">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> updateAccountTime(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, timeStamp: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>):</span>
<span id="cb1-271">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UpdateAccountTime. Time:"</span>, timeStamp)</span>
<span id="cb1-272"></span>
<span id="cb1-273">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@iswrapper</span></span>
<span id="cb1-274">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> updateAccountValue(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, key: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, val: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, currency: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, accountName: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>):</span>
<span id="cb1-275">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UpdateAccountValue. Key:"</span>, key, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Value:"</span>, val, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Currency:"</span>, currency, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AccountName:"</span>, accountName)</span>
<span id="cb1-276"></span>
<span id="cb1-277">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@iswrapper</span></span>
<span id="cb1-278">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> position(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, account: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, contract: Contract, position: Decimal, avgCost: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>):</span>
<span id="cb1-279">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.positions.append([contract, position, avgCost])</span>
<span id="cb1-280">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Position."</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Account:"</span>, account, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Contract:"</span>, contract, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Position:"</span>, position, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Avg cost:"</span>, avgCost)</span>
<span id="cb1-281">        </span>
<span id="cb1-282">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> positionEnd(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb1-283">       <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PositionEnd"</span>)</span>
<span id="cb1-284"></span>
<span id="cb1-285">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> orderStatus(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, orderId: OrderId, status: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, filled: Decimal, remaining: Decimal, avgFillPrice: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>, permId: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>, parentId: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>, lastFillPrice: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>, clientId: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>, whyHeld: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, mktCapPrice: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>):</span>
<span id="cb1-286">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OrderStatus. Id:"</span>, orderId, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Status:"</span>, status, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Filled:"</span>, decimalMaxString(filled), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Remaining:"</span>, decimalMaxString(remaining), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AvgFillPrice:"</span>, floatMaxString(avgFillPrice), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PermId:"</span>, intMaxString(permId), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ParentId:"</span>, intMaxString(parentId), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LastFillPrice:"</span>, floatMaxString(lastFillPrice), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ClientId:"</span>, intMaxString(clientId), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"WhyHeld:"</span>, whyHeld, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"MktCapPrice:"</span>, floatMaxString(mktCapPrice))</span>
<span id="cb1-287"></span>
<span id="cb1-288">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> openOrderEnd(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb1-289">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OpenOrderEnd"</span>)</span>
<span id="cb1-290"></span>
<span id="cb1-291"></span>
<span id="cb1-292">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@iswrapper</span></span>
<span id="cb1-293">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_positions(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb1-294">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get all current positions from an account</span></span>
<span id="cb1-295">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.connected:</span>
<span id="cb1-296">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Error: You're not connected to IBKR ..."</span>)</span>
<span id="cb1-297">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> []</span>
<span id="cb1-298">        </span>
<span id="cb1-299">        positions <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.positions()</span>
<span id="cb1-300">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Found </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(positions) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> open positions"</span>)</span>
<span id="cb1-301">        </span>
<span id="cb1-302">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> pos <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> positions:</span>
<span id="cb1-303">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  • </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>pos<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>contract<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>symbol<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> pos<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>position<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> contracts @ $</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> pos<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>avgCost<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb1-304">        </span>
<span id="cb1-305">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> positions</span>
<span id="cb1-306"></span>
<span id="cb1-307">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Order-related wrappers</span></span>
<span id="cb1-308">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@iswrapper</span></span>
<span id="cb1-309">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> openOrder(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, orderId, contract, order, orderState):</span>
<span id="cb1-310">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.open_orders.append([orderId, contract, order, orderState])</span>
<span id="cb1-311"></span>
<span id="cb1-312">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Order ID: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> orderId<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, contract: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> contract <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, order: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> order <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb1-313">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">super</span>().openOrder(orderId, contract, order, orderState)</span>
<span id="cb1-314">    </span>
<span id="cb1-315">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@iswrapper</span></span>
<span id="cb1-316">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> orderStatus(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, orderId, status, filled, remaining, avgFillPrice, permId, parentId, lastFillPrice, clientId, whyHeld, mktCapPrice):</span>
<span id="cb1-317">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Order ID: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> orderId <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, status: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> status <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, filled: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> filled <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, remaining: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> remaining <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, lastFillPrice: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> lastFillPrice <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, permID: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> permId <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, avgFillPrice: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> avgFillPrice <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb1-318">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">super</span>().orderStatus(orderId, status, filled, remaining, avgFillPrice, permId, parentId, lastFillPrice, clientId, whyHeld, mktCapPrice)</span>
<span id="cb1-319">    </span>
<span id="cb1-320">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@iswrapper</span></span>
<span id="cb1-321">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> execDetails(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, reqId, contract, execution):</span>
<span id="cb1-322">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Execution details. Request ID: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> reqId <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, contract: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> contract <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, execution: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> execution <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb1-323">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">super</span>().execDetails(reqId, contract, execution)</span>
<span id="cb1-324"></span>
<span id="cb1-325"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> update_once(ibkr_client):</span>
<span id="cb1-326">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Example: Connect to IBKR and update stops once</span></span>
<span id="cb1-327">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"="</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">70</span>)</span>
<span id="cb1-328">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"One-Time Stop Update"</span>)</span>
<span id="cb1-329">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"="</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">70</span>)</span>
<span id="cb1-330">    </span>
<span id="cb1-331">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb1-332">        ibkr_account <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> os.getenv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"IBKR_ACCOUNT_ID"</span>) </span>
<span id="cb1-333">        manager <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChandelierStopManager(ibkr_client <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ibkr_client, ibkr_account <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ibkr_account)</span>
<span id="cb1-334">        manager.update_stops_for_all_positions(multiplier <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ATR_MULTIPLIER)</span>
<span id="cb1-335">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">KeyError</span>:</span>
<span id="cb1-336">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Yikes! No IBKR account ID available..."</span>)</span>
<span id="cb1-337"></span>
<span id="cb1-338"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">__name__</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"__main__"</span>:</span>
<span id="cb1-339">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"="</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">70</span>)</span>
<span id="cb1-340">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CHANDELIER STOP SYSTEM ..."</span>)</span>
<span id="cb1-341">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"="</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">70</span>)</span>
<span id="cb1-342"></span>
<span id="cb1-343">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Connect to Interactive Brokers API via IB Gateway (v10.37 in this case...)</span></span>
<span id="cb1-344">    ib_client <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> IBApiClient(IBApiClient.IBKR_GATEWAY_ADDRESS, IBApiClient.IBKR_TESTING_PORT, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10252025</span>)</span>
<span id="cb1-345">    </span>
<span id="cb1-346">    time.sleep(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>)</span>
<span id="cb1-347"></span>
<span id="cb1-348">    update_once(ib_client)</span>
<span id="cb1-349">    </span></code></pre></div>
</div>
<p>And when it runs, this is what you get! This run is based on my paper trading account with an existing <code>SPY</code> position (shares, not options) I bought when it was at $540.59-ish.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://tiffani.dev/posts/on-volatility-driven-stops-chandelier-stops-in-ibkr/chandelier-output.png" class="img-fluid figure-img"></p>
<figcaption>Chandelier stop paper trading account run</figcaption>
</figure>
</div>
</section>
<section id="whats-next" class="level3">
<h3 class="anchored" data-anchor-id="whats-next">What’s next?</h3>
<p>Elder himself admits that the “…negative side of Chandelier Exits is that they give up a great deal of profit. Three Average True Ranges can amount to a lot of money in a volatile market.” He recommends experimenting with the Average True Range coefficient (<code>ATR_MULTIPLIER</code> in my code).</p>
<p>The code listed here does not include the portion that takes a volatility and calculates the option price to set a stop. I will update with that soon.</p>
<p>Finally, some of this code could be cleaned up. The Interactive Brokers API callback methods are mostly from their developer documentation.</p>


</section>

 ]]></description>
  <category>code</category>
  <category>Python</category>
  <category>risk management</category>
  <category>Interactive Brokers</category>
  <category>APIs</category>
  <guid>https://tiffani.dev/posts/on-volatility-driven-stops-chandelier-stops-in-ibkr/</guid>
  <pubDate>Thu, 06 Nov 2025 05:00:00 GMT</pubDate>
  <media:content url="https://tiffani.dev/posts/on-volatility-driven-stops-chandelier-stops-in-ibkr/chandelier-output.png" medium="image" type="image/png" height="118" width="144"/>
</item>
<item>
  <title>Live at the OPRA - Watching options order flow with Python</title>
  <dc:creator>Tiffani Ashley Bell</dc:creator>
  <link>https://tiffani.dev/posts/live-at-the-opra-options-order-flow-data-with-python/</link>
  <description><![CDATA[ 





<p>I trade options via Interactive Brokers and their <a href="https://www.ibkrguides.com/traderworkstation/getting-started.htm">Trader Workstation</a> software. At a certain point, though, I realized their option chain interface did not always show the <em>true</em> last price a particular option traded at. Bid-ask info would be updated continuously, but not necessarily last price. I was then potentially <strong>getting a false sense of what was actually happening at any given strike</strong> and actually missing out on useful information. And the thing is, I pay for real-time data from the exchanges via IBKR, so there was no good reason to be seeing stale price data.</p>
<p>I remembered that <a href="https://www.databento.com">Databento</a> offers real-time OPRA data feeds, so I decided to sign up for that. It’s $199/mo, but I would argue it’s been totally worth it to see options order flow in real-time all throughout the trading day. You also get statistics about all the options you’re interested in when the exchanges close for the day.</p>
<p>This code sample doesn’t deviate much from the sample Databento offers to get you started with live data, but for a while this is what I used to watch real-time options order flow every weekday.</p>
<div id="9c46839f" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> databento <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> db</span>
<span id="cb1-2"></span>
<span id="cb1-3">db.enable_logging(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"INFO"</span>)</span>
<span id="cb1-4"></span>
<span id="cb1-5">symbols <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GS    251219C00850000"</span>,]</span>
<span id="cb1-6"></span>
<span id="cb1-7">live_client <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> db.Live(API_KEY)</span>
<span id="cb1-8"></span>
<span id="cb1-9">live_client.subscribe(</span>
<span id="cb1-10">    dataset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OPRA.PILLAR"</span>,</span>
<span id="cb1-11">    schema <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"status"</span>,</span>
<span id="cb1-12">    symbols <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> symbols,</span>
<span id="cb1-13">    stype_in <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"raw_symbol"</span>,</span>
<span id="cb1-14">)</span>
<span id="cb1-15"></span>
<span id="cb1-16">live_client.subscribe(</span>
<span id="cb1-17">    dataset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OPRA.PILLAR"</span>,</span>
<span id="cb1-18">    schema <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tcbbo"</span>,</span>
<span id="cb1-19">    symbols <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> symbols,</span>
<span id="cb1-20">    stype_in <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"raw_symbol"</span>,</span>
<span id="cb1-21">)</span>
<span id="cb1-22"></span>
<span id="cb1-23">live_client.subscribe(</span>
<span id="cb1-24">    dataset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OPRA.PILLAR"</span>,</span>
<span id="cb1-25">    schema <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"statistics"</span>,</span>
<span id="cb1-26">    symbols <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> symbols,</span>
<span id="cb1-27">    stype_in <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"raw_symbol"</span>,</span>
<span id="cb1-28">)</span>
<span id="cb1-29"></span>
<span id="cb1-30">live_client.add_callback(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>)</span>
<span id="cb1-31">live_client.start()</span></code></pre></div></div>
</div>
<p>This turned into:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://tiffani.dev/posts/live-at-the-opra-options-order-flow-data-with-python/opra-data.png" class="img-fluid figure-img"></p>
<figcaption>OPRA data flow from Databento</figcaption>
</figure>
</div>
<p>Unfortunately, the raw output from the feed is very hard to read and follow what is happening with the options you’re interested in.</p>
<p>In particular, the feed shows which option is which in the order flow via the <code>instrument_id</code>, but it’s a number, not a somewhat human-readable identifier (with issuer, date, and strike such as <code>GS 251219C00850000</code>). Or even better, a <em>Goldman Sachs December 2025 850 call</em>. The feed gives you a listing of what <code>instrument_id</code> is tied to which option and strike, but that happens when the feed first launches. After that, there’s no easy way to know what you’re looking at. That calls for some modifications!</p>
<p>I cooked up something that makes order flow much more readable.</p>
<div id="b51cf10c" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb2-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> databento <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> db</span>
<span id="cb2-3"></span>
<span id="cb2-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Prices don't come in 2-decimal form</span></span>
<span id="cb2-5">OPT_PRICE_DIV <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000000000</span></span>
<span id="cb2-6"></span>
<span id="cb2-7">symbol_mappings <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {}</span>
<span id="cb2-8"></span>
<span id="cb2-9"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> order_flow_print(order_flow_data):</span>
<span id="cb2-10">    msg_type <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span>(order_flow_data)</span>
<span id="cb2-11"></span>
<span id="cb2-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span>(msg_type <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> db.SymbolMappingMsg):</span>
<span id="cb2-13">        instrument_id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> order_flow_data.instrument_id</span>
<span id="cb2-14">        issuer_symbol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> order_flow_data.stype_out_symbol</span>
<span id="cb2-15">        symbol_mappings[instrument_id] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> issuer_symbol</span>
<span id="cb2-16">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span>(msg_type <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> db.CMBP1Msg):</span>
<span id="cb2-17">        header <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> order_flow_data.hd</span>
<span id="cb2-18">        instrument_id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> header.instrument_id</span>
<span id="cb2-19">        order_price <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> order_flow_data.price <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> OPT_PRICE_DIV</span>
<span id="cb2-20">        order_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> order_flow_data.size</span>
<span id="cb2-21">        symbol_str <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> symbol_mappings[instrument_id]</span>
<span id="cb2-22"></span>
<span id="cb2-23">        bid_ask <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> order_flow_data.levels[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb2-24">        bid_price <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> bid_ask.bid_px <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> OPT_PRICE_DIV</span>
<span id="cb2-25">        ask_price <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> bid_ask.ask_px <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> OPT_PRICE_DIV</span>
<span id="cb2-26">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> symbol_str <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> - </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> order_size <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> @ $</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> order_price <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb2-27">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Bid: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> bid_price <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">x</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> bid_ask<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>bid_sz <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">  Ask: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> ask_price <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">x</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> bid_ask<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>ask_sz<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb2-28">    </span>
<span id="cb2-29"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">__name__</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"__main__"</span>:</span>
<span id="cb2-30">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb2-31">        databento_api_key <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> os.getenv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"DATABENTO_API_KEY"</span>)</span>
<span id="cb2-32">        live_client <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> db.Live(databento_api_key)</span>
<span id="cb2-33">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">KeyError</span>:</span>
<span id="cb2-34">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Oops! DATABENTO_API_KEY not found..."</span>)</span>
<span id="cb2-35"></span>
<span id="cb2-36">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Show all the order flow for a given issuer (in this case, Goldman Sachs and JP Morgan)</span></span>
<span id="cb2-37">    symbols <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GS.OPT"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"JPM.OPT"</span>, ]</span>
<span id="cb2-38"></span>
<span id="cb2-39">    live_client.subscribe(</span>
<span id="cb2-40">        dataset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OPRA.PILLAR"</span>,</span>
<span id="cb2-41">        schema <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"status"</span>,</span>
<span id="cb2-42">        symbols <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> symbols,</span>
<span id="cb2-43">        stype_in <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"parent"</span>,</span>
<span id="cb2-44">    )</span>
<span id="cb2-45"></span>
<span id="cb2-46">    live_client.subscribe(</span>
<span id="cb2-47">        dataset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OPRA.PILLAR"</span>,</span>
<span id="cb2-48">        schema <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tcbbo"</span>,</span>
<span id="cb2-49">        symbols <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> symbols,</span>
<span id="cb2-50">        stype_in <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"parent"</span>,</span>
<span id="cb2-51">    )</span>
<span id="cb2-52"></span>
<span id="cb2-53">    live_client.subscribe(</span>
<span id="cb2-54">        dataset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OPRA.PILLAR"</span>,</span>
<span id="cb2-55">        schema <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"statistics"</span>,</span>
<span id="cb2-56">        symbols <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> symbols,</span>
<span id="cb2-57">        stype_in <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"parent"</span>,</span>
<span id="cb2-58">    )</span>
<span id="cb2-59"></span>
<span id="cb2-60">    live_client.add_callback(order_flow_print)</span>
<span id="cb2-61">    live_client.start()</span></code></pre></div></div>
</div>
<p>And with much more readable output:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://tiffani.dev/posts/live-at-the-opra-options-order-flow-data-with-python/opra-data-readable.png" class="img-fluid figure-img"></p>
<figcaption>Updated OPRA order data flow from Databento</figcaption>
</figure>
</div>
<p>Of course, it could be improved even from here, but that’s for another day. <a href="https://www.cfainstitute.org/">CFA</a> and <a href="https://www.cmtassociation.org">CMT</a> studying awaits…</p>



 ]]></description>
  <category>code</category>
  <category>options</category>
  <category>Python</category>
  <category>Databento</category>
  <category>market microstructure</category>
  <guid>https://tiffani.dev/posts/live-at-the-opra-options-order-flow-data-with-python/</guid>
  <pubDate>Sun, 02 Nov 2025 04:00:00 GMT</pubDate>
  <media:content url="https://tiffani.dev/posts/live-at-the-opra-options-order-flow-data-with-python/opra-data.png" medium="image" type="image/png" height="88" width="144"/>
</item>
<item>
  <title>Welcome To My Blog</title>
  <dc:creator>Tiffani Ashley Bell</dc:creator>
  <link>https://tiffani.dev/posts/welcome/</link>
  <description><![CDATA[ 





<p>This is the first post in a Quarto blog. Welcome!</p>
<p><img src="https://tiffani.dev/posts/welcome/thumbnail.jpg" class="img-fluid"></p>
<p>Since this post doesn’t specify an explicit <code>image</code>, the first image in the post will be used in the listing page of posts.</p>



 ]]></description>
  <category>news</category>
  <guid>https://tiffani.dev/posts/welcome/</guid>
  <pubDate>Thu, 30 Oct 2025 04:00:00 GMT</pubDate>
</item>
</channel>
</rss>
