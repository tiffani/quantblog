<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Tiffani Ashley Bell">
<meta name="dcterms.date" content="2025-11-06">

<title>On Volatility-Driven Trailing Stops - Chandelier Stops via the Interactive Brokers API – Musings</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-a8976c3e89df70b272bdfba3d2fda974.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="On Volatility-Driven Trailing Stops - Chandelier Stops via the Interactive Brokers API – Musings">
<meta property="og:description" content="A place where I learn…">
<meta property="og:image" content="https://tiffani.dev/posts/on-volatility-driven-stops-chandelier-stops-in-ibkr/chandelier-output-1.png">
<meta property="og:site_name" content="Musings">
<meta property="og:image:height" content="2320">
<meta property="og:image:width" content="2836">
<meta name="twitter:title" content="On Volatility-Driven Trailing Stops - Chandelier Stops via the Interactive Brokers API – Musings">
<meta name="twitter:description" content="A place where I learn…">
<meta name="twitter:image" content="https://tiffani.dev/posts/on-volatility-driven-stops-chandelier-stops-in-ibkr/chandelier-output-1.png">
<meta name="twitter:creator" content="@tiffani">
<meta name="twitter:image-height" content="2320">
<meta name="twitter:image-width" content="2836">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed fullcontent quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Musings</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/tiffani"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/tiffani"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">On Volatility-Driven Trailing Stops - Chandelier Stops via the Interactive Brokers API</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">code</div>
                <div class="quarto-category">Python</div>
                <div class="quarto-category">risk management</div>
                <div class="quarto-category">Interactive Brokers</div>
                <div class="quarto-category">APIs</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Tiffani Ashley Bell </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">November 6, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="cut-your-losses-let-your-gains-run-just-not-away" class="level3">
<h3 class="anchored" data-anchor-id="cut-your-losses-let-your-gains-run-just-not-away">“Cut your losses, let your gains run…” (just not <em>away</em>)</h3>
<p>Having a better methodology for stops and capturing unrealized gains became super important after a certain set of recent disappointing trades. Goldman ran up to an all-time-high of $825.25 ahead of a Jerome Powell speech on September 22, 2025. The positions I held at that point were the result of a few days of analysis, familiarizing myself with more of the statistical properties of the things I am trading—especially in tandem with working through the Quantitative Methods book for the <a href="https://www.cfainstitute.org">CFA</a> exam in February 2026.</p>
<p>I did a five-year analysis of Goldman’s daily returns dating back to January 2020. They showed 2.36 excess kurtosis and positive skew. In English, that is a stock that has small losses here and there, but a few very large gains. This was a very large gain…and yet I did not capture enough of this move.</p>
<p>I experienced a gain of 584.8% on a GS Oct 2026 800 call after GS rocketed to that all-time-high. Unfortunately, my stop did not hug this position tightly enough and in the subsequent drop gave back nearly half those gains. This was sad and preventable!</p>
</section>
<section id="what-is-a-chandelier-stop" class="level3">
<h3 class="anchored" data-anchor-id="what-is-a-chandelier-stop">What is a “chandelier stop”?</h3>
<p>Interactive Brokers’s Trader Workstation offers trailing stops. They are fixed, however. You can set a percentage or a fixed value for the stop. But, then you must through the rigamarole of determining what percentage or absolute value to use. And even after you do that, though, that’s it. The parameter you set for how wide (permissive) or how narrow (restrictive) your trailing stop is doesn’t change.</p>
<p>I have been wanting to understand if having a stop that adjusts dynamically based on an underlying’s volatility made sense. And hey! It turns out this exists and it is called a <strong>chandelier stop</strong>. I first read about this in Dr.&nbsp;Alexander Elder’s <em>Come Into My Trading Room</em>. <strong>It uses the average true range of an underlying to turn volatility into a way to determine where stops should go.</strong></p>
<p>A chandelier stop is set with volatility in mind and may retreat as prices move around. This is basically the mechanical embodiment of <em>breathing room</em>. It can be used for both entries and exits.</p>
<p>As Elder says</p>
<blockquote class="blockquote">
<p>When traders are long, it hangs their stops from the highest peak reached by that trend, like a chandelier hangs from the tallest point in the room. As prices move up, the Chadelier Exit, suspended from the highest point of that trend, also rises. It tracks volatility as well as prices, as its distance from the peak grows with the rise in volatility. […] There is no telling how high a trend may go, and a Chandelier will rise until prices peel off from the ceiling and hit that stop.</p>
</blockquote>
<p>How much breathing room it has is, of course, the product of the parameters used to create the stop. The chandelier stop consists of a lookback period and the average true range (both to calculate volatility).</p>
</section>
<section id="working-with-interactive-brokerss-api-v10.37" class="level3">
<h3 class="anchored" data-anchor-id="working-with-interactive-brokerss-api-v10.37">Working with Interactive Brokers’s API (v10.37+)</h3>
<p>What’s nice is that Interactive Brokers has an API and <a href="https://www.interactivebrokers.com/campus/ibkr-quant-news/interactive-brokers-python-api-native-a-step-by-step-guide/">Python</a> libraries for programmatically interacting with your trading account. The APIs are extensive and take some effort to understand, though. (Some things are not documented very well, others are not documented at all unless you’ve joined a mailing list for support.) Once you get everything running, it is nothing to then start putting on and managing trades via Python—including creating a chandelier stop to manage a long call position that is in the green!</p>
<p>The code below uses Interactive Brokers’s Python library <code>ibapi</code> version 10.37 to execute trades using IBGateway version 10.37 starting in October 2025.</p>
<p>This works, but is also still a work in progress.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>ibkr-chandelier.py</strong></pre>
</div>
<div class="sourceCode" id="cb1" data-filename="ibkr-chandelier.py"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"></a><span class="co"># Written to accommodate IBApi libraries 10.30 or above.</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="co"># Also built this using 10.37 version of IBGateway.</span></span>
<span id="cb1-3"><a href="#cb1-3"></a></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="im">import</span> os</span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="im">import</span> time</span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="im">import</span> datetime</span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="im">import</span> threading</span>
<span id="cb1-8"><a href="#cb1-8"></a></span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="im">import</span> yfinance <span class="im">as</span> yf</span>
<span id="cb1-11"><a href="#cb1-11"></a></span>
<span id="cb1-12"><a href="#cb1-12"></a><span class="im">from</span> ibapi.client <span class="im">import</span> <span class="op">*</span></span>
<span id="cb1-13"><a href="#cb1-13"></a><span class="im">from</span> ibapi.wrapper <span class="im">import</span> <span class="op">*</span></span>
<span id="cb1-14"><a href="#cb1-14"></a><span class="im">from</span> ibapi.contract <span class="im">import</span> <span class="op">*</span></span>
<span id="cb1-15"><a href="#cb1-15"></a><span class="im">from</span> ibapi.utils <span class="im">import</span> iswrapper</span>
<span id="cb1-16"><a href="#cb1-16"></a><span class="im">from</span> ibapi.ticktype <span class="im">import</span> TickTypeEnum</span>
<span id="cb1-17"><a href="#cb1-17"></a></span>
<span id="cb1-18"><a href="#cb1-18"></a><span class="im">from</span> decimal <span class="im">import</span> Decimal, ROUND_CEILING</span>
<span id="cb1-19"><a href="#cb1-19"></a></span>
<span id="cb1-20"><a href="#cb1-20"></a>ATR_MULTIPLIER <span class="op">=</span> <span class="dv">3</span>  <span class="co"># 3x ATR for stocks, 3-4x for options</span></span>
<span id="cb1-21"><a href="#cb1-21"></a>ATR_PERIOD <span class="op">=</span> <span class="dv">10</span> <span class="co"># Standard ATR period</span></span>
<span id="cb1-22"><a href="#cb1-22"></a>LOOKBACK_PERIOD <span class="op">=</span> <span class="dv">10</span> <span class="co"># Days to look back for highest high</span></span>
<span id="cb1-23"><a href="#cb1-23"></a></span>
<span id="cb1-24"><a href="#cb1-24"></a><span class="co"># Need to round to next nickel to accommodate minimum order tick sizes</span></span>
<span id="cb1-25"><a href="#cb1-25"></a><span class="kw">def</span> round_to_nickel(price):</span>
<span id="cb1-26"><a href="#cb1-26"></a>    <span class="cf">return</span> <span class="bu">float</span>((Decimal(<span class="bu">str</span>(price)) <span class="op">/</span> Decimal(<span class="st">'0.05'</span>)).quantize(Decimal(<span class="st">'1'</span>), rounding <span class="op">=</span> ROUND_CEILING) <span class="op">*</span> Decimal(<span class="st">'0.05'</span>))</span>
<span id="cb1-27"><a href="#cb1-27"></a></span>
<span id="cb1-28"><a href="#cb1-28"></a><span class="kw">class</span> ChandelierStopManager:</span>
<span id="cb1-29"><a href="#cb1-29"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, ibkr_client, ibkr_account):</span>
<span id="cb1-30"><a href="#cb1-30"></a>        <span class="va">self</span>.ibkr_client <span class="op">=</span> ibkr_client</span>
<span id="cb1-31"><a href="#cb1-31"></a>        <span class="va">self</span>.ibkr_account <span class="op">=</span> ibkr_account</span>
<span id="cb1-32"><a href="#cb1-32"></a></span>
<span id="cb1-33"><a href="#cb1-33"></a>    <span class="kw">def</span> _cancel_existing_stops(<span class="va">self</span>, ticker):</span>
<span id="cb1-34"><a href="#cb1-34"></a>        <span class="co"># Cancel existing stop orders for a ticker</span></span>
<span id="cb1-35"><a href="#cb1-35"></a>        open_orders <span class="op">=</span> <span class="va">self</span>.ib.openTrades()</span>
<span id="cb1-36"><a href="#cb1-36"></a>        </span>
<span id="cb1-37"><a href="#cb1-37"></a>        cancelled_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb1-38"><a href="#cb1-38"></a>        <span class="cf">for</span> trade <span class="kw">in</span> open_orders:</span>
<span id="cb1-39"><a href="#cb1-39"></a>            <span class="cf">if</span> (trade.contract.symbol <span class="op">==</span> ticker <span class="kw">and</span> trade.order.orderType <span class="kw">in</span> [<span class="st">'STP'</span>, <span class="st">'TRAIL'</span>]):</span>
<span id="cb1-40"><a href="#cb1-40"></a>                <span class="va">self</span>.ibkr_client.cancelOrder(trade.order)</span>
<span id="cb1-41"><a href="#cb1-41"></a>                cancelled_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb1-42"><a href="#cb1-42"></a>        </span>
<span id="cb1-43"><a href="#cb1-43"></a>        <span class="cf">if</span> cancelled_count <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb1-44"><a href="#cb1-44"></a>            <span class="bu">print</span>(<span class="ss">f"  Cancelled </span><span class="sc">{</span> cancelled_count <span class="sc">}</span><span class="ss"> existing stop order(s) ..."</span>)</span>
<span id="cb1-45"><a href="#cb1-45"></a></span>
<span id="cb1-46"><a href="#cb1-46"></a></span>
<span id="cb1-47"><a href="#cb1-47"></a>    <span class="co"># Calculate a chandelier stop for a given ticker</span></span>
<span id="cb1-48"><a href="#cb1-48"></a>    <span class="kw">def</span> calculate_chandelier_stop(<span class="va">self</span>, ticker, multiplier <span class="op">=</span> ATR_MULTIPLIER, period <span class="op">=</span> ATR_PERIOD):</span>
<span id="cb1-49"><a href="#cb1-49"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Calculating Chandelier Stop for </span><span class="sc">{</span> ticker <span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb1-50"><a href="#cb1-50"></a>        </span>
<span id="cb1-51"><a href="#cb1-51"></a>        <span class="co"># Download recent price data</span></span>
<span id="cb1-52"><a href="#cb1-52"></a>        data <span class="op">=</span> yf.download(ticker, period <span class="op">=</span> <span class="st">'2mo'</span>, interval <span class="op">=</span> <span class="st">'1d'</span>, progress <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb1-53"><a href="#cb1-53"></a>        </span>
<span id="cb1-54"><a href="#cb1-54"></a>        <span class="cf">if</span> data.empty:</span>
<span id="cb1-55"><a href="#cb1-55"></a>            <span class="bu">print</span>(<span class="ss">f"Yikes: Could not download data for </span><span class="sc">{</span> ticker <span class="sc">}</span><span class="ss"> ..."</span>)</span>
<span id="cb1-56"><a href="#cb1-56"></a>            <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb1-57"><a href="#cb1-57"></a>        </span>
<span id="cb1-58"><a href="#cb1-58"></a>        <span class="co"># Calculate True Range components</span></span>
<span id="cb1-59"><a href="#cb1-59"></a>        high_low <span class="op">=</span> (data[<span class="st">'High'</span>][ticker] <span class="op">-</span> data[<span class="st">'Low'</span>][ticker])</span>
<span id="cb1-60"><a href="#cb1-60"></a>        high_close <span class="op">=</span> <span class="bu">abs</span>(data[<span class="st">'High'</span>][ticker] <span class="op">-</span> data[<span class="st">'Close'</span>][ticker].shift())</span>
<span id="cb1-61"><a href="#cb1-61"></a>        low_close <span class="op">=</span> <span class="bu">abs</span>(data[<span class="st">'Low'</span>][ticker] <span class="op">-</span> data[<span class="st">'Close'</span>][ticker].shift())</span>
<span id="cb1-62"><a href="#cb1-62"></a>        </span>
<span id="cb1-63"><a href="#cb1-63"></a>        <span class="co"># True Range = max of the three</span></span>
<span id="cb1-64"><a href="#cb1-64"></a>        true_range <span class="op">=</span> pd.concat([high_low, high_close, low_close], axis <span class="op">=</span> <span class="dv">1</span>).<span class="bu">max</span>(axis <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb1-65"><a href="#cb1-65"></a>        </span>
<span id="cb1-66"><a href="#cb1-66"></a>        <span class="co"># Average True Range (ATR)</span></span>
<span id="cb1-67"><a href="#cb1-67"></a>        atr <span class="op">=</span> true_range.rolling(period).mean()</span>
<span id="cb1-68"><a href="#cb1-68"></a>        current_atr <span class="op">=</span> atr.iloc[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb1-69"><a href="#cb1-69"></a>        </span>
<span id="cb1-70"><a href="#cb1-70"></a>        <span class="co"># Current price and highest high</span></span>
<span id="cb1-71"><a href="#cb1-71"></a>        current_price <span class="op">=</span> data[<span class="st">'Close'</span>][ticker].iloc[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb1-72"><a href="#cb1-72"></a>        highest_high <span class="op">=</span> data[<span class="st">'High'</span>][ticker].tail(period).<span class="bu">max</span>()</span>
<span id="cb1-73"><a href="#cb1-73"></a>        </span>
<span id="cb1-74"><a href="#cb1-74"></a>        <span class="co"># Chandelier Stop = Highest High - (Multiplier * ATR)</span></span>
<span id="cb1-75"><a href="#cb1-75"></a>        stop_level <span class="op">=</span> round_to_nickel(highest_high <span class="op">-</span> (multiplier <span class="op">*</span> current_atr))</span>
<span id="cb1-76"><a href="#cb1-76"></a>        </span>
<span id="cb1-77"><a href="#cb1-77"></a>        <span class="co"># Calculate distance to stop as percentage</span></span>
<span id="cb1-78"><a href="#cb1-78"></a>        distance_pct <span class="op">=</span> ((current_price <span class="op">-</span> stop_level) <span class="op">/</span> current_price) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb1-79"><a href="#cb1-79"></a>        </span>
<span id="cb1-80"><a href="#cb1-80"></a>        result <span class="op">=</span> {</span>
<span id="cb1-81"><a href="#cb1-81"></a>            <span class="st">'ticker'</span>: ticker,</span>
<span id="cb1-82"><a href="#cb1-82"></a>            <span class="st">'current_price'</span>: current_price,</span>
<span id="cb1-83"><a href="#cb1-83"></a>            <span class="st">'atr'</span>: current_atr,</span>
<span id="cb1-84"><a href="#cb1-84"></a>            <span class="st">'highest_high'</span>: highest_high,</span>
<span id="cb1-85"><a href="#cb1-85"></a>            <span class="st">'stop_level'</span>: stop_level,</span>
<span id="cb1-86"><a href="#cb1-86"></a>            <span class="st">'distance_pct'</span>: distance_pct,</span>
<span id="cb1-87"><a href="#cb1-87"></a>            <span class="st">'timestamp'</span>: datetime.datetime.now()</span>
<span id="cb1-88"><a href="#cb1-88"></a>        }</span>
<span id="cb1-89"><a href="#cb1-89"></a>        </span>
<span id="cb1-90"><a href="#cb1-90"></a>        <span class="co"># Print results</span></span>
<span id="cb1-91"><a href="#cb1-91"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span> <span class="st">'='</span> <span class="op">*</span> <span class="dv">50</span> <span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-92"><a href="#cb1-92"></a>        <span class="bu">print</span>(<span class="ss">f"Ticker: </span><span class="sc">{</span> ticker <span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-93"><a href="#cb1-93"></a>        <span class="bu">print</span>(<span class="ss">f"Current Price: $</span><span class="sc">{</span> current_price<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb1-94"><a href="#cb1-94"></a>        <span class="bu">print</span>(<span class="ss">f"ATR (</span><span class="sc">{</span> period <span class="sc">}</span><span class="ss">): $</span><span class="sc">{</span> current_atr<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb1-95"><a href="#cb1-95"></a>        <span class="bu">print</span>(<span class="ss">f"Highest High (</span><span class="sc">{</span> period <span class="sc">}</span><span class="ss">d): $</span><span class="sc">{</span> highest_high<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb1-96"><a href="#cb1-96"></a>        <span class="bu">print</span>(<span class="ss">f"Chandelier Stop: $</span><span class="sc">{</span> stop_level<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb1-97"><a href="#cb1-97"></a>        <span class="bu">print</span>(<span class="ss">f"Distance to Stop: </span><span class="sc">{</span> distance_pct<span class="sc">:.1f}</span><span class="ss">%"</span>)</span>
<span id="cb1-98"><a href="#cb1-98"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span> <span class="st">'='</span> <span class="op">*</span> <span class="dv">50</span> <span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb1-99"><a href="#cb1-99"></a>        </span>
<span id="cb1-100"><a href="#cb1-100"></a>        <span class="cf">return</span> result</span>
<span id="cb1-101"><a href="#cb1-101"></a>    </span>
<span id="cb1-102"><a href="#cb1-102"></a>    <span class="co"># Calculate and update Chandelier stops for all open positions</span></span>
<span id="cb1-103"><a href="#cb1-103"></a>    <span class="kw">def</span> update_stops_for_all_positions(<span class="va">self</span>, multiplier <span class="op">=</span> ATR_MULTIPLIER):</span>
<span id="cb1-104"><a href="#cb1-104"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="va">self</span>.ibkr_client.connected:</span>
<span id="cb1-105"><a href="#cb1-105"></a>            <span class="bu">print</span>(<span class="st">"Ooopps! You're not connected to IBKR..."</span>)</span>
<span id="cb1-106"><a href="#cb1-106"></a>            <span class="cf">return</span></span>
<span id="cb1-107"><a href="#cb1-107"></a>            </span>
<span id="cb1-108"><a href="#cb1-108"></a>        <span class="va">self</span>.ibkr_client.reqPositions()</span>
<span id="cb1-109"><a href="#cb1-109"></a></span>
<span id="cb1-110"><a href="#cb1-110"></a>        time.sleep(<span class="dv">10</span>)</span>
<span id="cb1-111"><a href="#cb1-111"></a></span>
<span id="cb1-112"><a href="#cb1-112"></a>        positions <span class="op">=</span> <span class="va">self</span>.ibkr_client.positions</span>
<span id="cb1-113"><a href="#cb1-113"></a>            </span>
<span id="cb1-114"><a href="#cb1-114"></a>        <span class="cf">if</span> <span class="kw">not</span> positions:</span>
<span id="cb1-115"><a href="#cb1-115"></a>            <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">No positions to update"</span>)</span>
<span id="cb1-116"><a href="#cb1-116"></a>            <span class="cf">return</span></span>
<span id="cb1-117"><a href="#cb1-117"></a>            </span>
<span id="cb1-118"><a href="#cb1-118"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span> <span class="st">'='</span> <span class="op">*</span> <span class="dv">70</span> <span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-119"><a href="#cb1-119"></a>        <span class="bu">print</span>(<span class="st">"UPDATING CHANDELIER STOPS..."</span>)</span>
<span id="cb1-120"><a href="#cb1-120"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span> <span class="st">'='</span> <span class="op">*</span> <span class="dv">70</span> <span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb1-121"><a href="#cb1-121"></a>            </span>
<span id="cb1-122"><a href="#cb1-122"></a>        <span class="cf">for</span> position <span class="kw">in</span> positions:</span>
<span id="cb1-123"><a href="#cb1-123"></a>            <span class="cf">if</span> position[<span class="dv">1</span>] <span class="op">&gt;</span> <span class="dv">0</span>:  <span class="co"># Only for long positions</span></span>
<span id="cb1-124"><a href="#cb1-124"></a>                ticker <span class="op">=</span> position[<span class="dv">0</span>].symbol</span>
<span id="cb1-125"><a href="#cb1-125"></a>                quantity <span class="op">=</span> position[<span class="dv">1</span>]</span>
<span id="cb1-126"><a href="#cb1-126"></a>                    </span>
<span id="cb1-127"><a href="#cb1-127"></a>                <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">--- Processing </span><span class="sc">{</span> ticker <span class="sc">}</span><span class="ss"> ---"</span>)</span>
<span id="cb1-128"><a href="#cb1-128"></a>                    </span>
<span id="cb1-129"><a href="#cb1-129"></a>                <span class="co"># Calculate Chandelier stop level</span></span>
<span id="cb1-130"><a href="#cb1-130"></a>                stop_data <span class="op">=</span> <span class="va">self</span>.calculate_chandelier_stop(ticker, multiplier)</span>
<span id="cb1-131"><a href="#cb1-131"></a>                    </span>
<span id="cb1-132"><a href="#cb1-132"></a>                <span class="cf">if</span> stop_data <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb1-133"><a href="#cb1-133"></a>                    <span class="bu">print</span>(<span class="ss">f"Skipping </span><span class="sc">{</span> ticker <span class="sc">}</span><span class="ss"> - could not calculate stop ..."</span>)</span>
<span id="cb1-134"><a href="#cb1-134"></a>                    <span class="cf">continue</span></span>
<span id="cb1-135"><a href="#cb1-135"></a>                    </span>
<span id="cb1-136"><a href="#cb1-136"></a>                stop_level <span class="op">=</span> stop_data[<span class="st">'stop_level'</span>]</span>
<span id="cb1-137"><a href="#cb1-137"></a>                    </span>
<span id="cb1-138"><a href="#cb1-138"></a>                <span class="co"># Cancel any existing stop orders for this position</span></span>
<span id="cb1-139"><a href="#cb1-139"></a>                <span class="va">self</span>._cancel_existing_stops(ticker)</span>
<span id="cb1-140"><a href="#cb1-140"></a>                    </span>
<span id="cb1-141"><a href="#cb1-141"></a>                <span class="co"># Place new stop order</span></span>
<span id="cb1-142"><a href="#cb1-142"></a>                <span class="va">self</span>._place_stop_order(position[<span class="dv">0</span>], quantity, stop_level)</span>
<span id="cb1-143"><a href="#cb1-143"></a></span>
<span id="cb1-144"><a href="#cb1-144"></a>    <span class="kw">def</span> _cancel_existing_stops(<span class="va">self</span>, ticker):</span>
<span id="cb1-145"><a href="#cb1-145"></a>        <span class="co"># Cancel existing stop orders for a ticker</span></span>
<span id="cb1-146"><a href="#cb1-146"></a>        <span class="va">self</span>.ibkr_client.reqAllOpenOrders()</span>
<span id="cb1-147"><a href="#cb1-147"></a></span>
<span id="cb1-148"><a href="#cb1-148"></a>        time.sleep(<span class="dv">10</span>)</span>
<span id="cb1-149"><a href="#cb1-149"></a>            </span>
<span id="cb1-150"><a href="#cb1-150"></a>        cancelled_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb1-151"><a href="#cb1-151"></a>        <span class="cf">for</span> trade <span class="kw">in</span> <span class="va">self</span>.ibkr_client.open_orders:</span>
<span id="cb1-152"><a href="#cb1-152"></a>            <span class="cf">if</span> (trade[<span class="dv">1</span>].symbol <span class="op">==</span> ticker <span class="kw">and</span> trade[<span class="dv">2</span>].orderType <span class="kw">in</span> [<span class="st">'STP'</span>, <span class="st">'TRAIL'</span>]):</span>
<span id="cb1-153"><a href="#cb1-153"></a>                <span class="va">self</span>.ibkr_client.cancelOrder(trade[<span class="dv">0</span>], OrderCancel())</span>
<span id="cb1-154"><a href="#cb1-154"></a>                cancelled_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb1-155"><a href="#cb1-155"></a>            </span>
<span id="cb1-156"><a href="#cb1-156"></a>        <span class="cf">if</span> cancelled_count <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb1-157"><a href="#cb1-157"></a>            <span class="bu">print</span>(<span class="ss">f"  Cancelled </span><span class="sc">{</span> cancelled_count <span class="sc">}</span><span class="ss"> existing stop order(s) ..."</span>)</span>
<span id="cb1-158"><a href="#cb1-158"></a></span>
<span id="cb1-159"><a href="#cb1-159"></a>    <span class="kw">def</span> _place_stop_order(<span class="va">self</span>, contract, quantity, stop_price):</span>
<span id="cb1-160"><a href="#cb1-160"></a>        <span class="co"># Place a stop-loss order</span></span>
<span id="cb1-161"><a href="#cb1-161"></a>        order <span class="op">=</span> Order()</span>
<span id="cb1-162"><a href="#cb1-162"></a>        order.action <span class="op">=</span> <span class="st">'SELL'</span></span>
<span id="cb1-163"><a href="#cb1-163"></a>        order.orderType <span class="op">=</span> <span class="st">'STP'</span></span>
<span id="cb1-164"><a href="#cb1-164"></a>        order.totalQuantity <span class="op">=</span> quantity</span>
<span id="cb1-165"><a href="#cb1-165"></a>        order.auxPrice <span class="op">=</span> stop_price  <span class="co"># Stop trigger price</span></span>
<span id="cb1-166"><a href="#cb1-166"></a>        order.account <span class="op">=</span> <span class="va">self</span>.ibkr_account</span>
<span id="cb1-167"><a href="#cb1-167"></a>        order.tif <span class="op">=</span> <span class="st">'GTC'</span></span>
<span id="cb1-168"><a href="#cb1-168"></a></span>
<span id="cb1-169"><a href="#cb1-169"></a>        contract.exchange <span class="op">=</span> <span class="st">'SMART'</span></span>
<span id="cb1-170"><a href="#cb1-170"></a>            </span>
<span id="cb1-171"><a href="#cb1-171"></a>        oid <span class="op">=</span> <span class="va">self</span>.ibkr_client.nextId()</span>
<span id="cb1-172"><a href="#cb1-172"></a></span>
<span id="cb1-173"><a href="#cb1-173"></a>        <span class="co"># Place the order</span></span>
<span id="cb1-174"><a href="#cb1-174"></a>        trade <span class="op">=</span> <span class="va">self</span>.ibkr_client.placeOrder(oid, contract, order)</span>
<span id="cb1-175"><a href="#cb1-175"></a>            </span>
<span id="cb1-176"><a href="#cb1-176"></a>        <span class="bu">print</span>(<span class="ss">f"  ✓ Placed stop order at $</span><span class="sc">{</span> stop_price<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb1-177"><a href="#cb1-177"></a>        <span class="bu">print</span>(<span class="ss">f"    Quantity: </span><span class="sc">{</span> quantity <span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-178"><a href="#cb1-178"></a>            </span>
<span id="cb1-179"><a href="#cb1-179"></a>        <span class="cf">return</span> trade</span>
<span id="cb1-180"><a href="#cb1-180"></a></span>
<span id="cb1-181"><a href="#cb1-181"></a></span>
<span id="cb1-182"><a href="#cb1-182"></a><span class="co"># This is set up to serve as the client and the wrapper</span></span>
<span id="cb1-183"><a href="#cb1-183"></a><span class="kw">class</span> IBApiClient(EWrapper, EClient):</span>
<span id="cb1-184"><a href="#cb1-184"></a>    IBKR_GATEWAY_ADDRESS <span class="op">=</span> <span class="st">'127.0.0.1'</span></span>
<span id="cb1-185"><a href="#cb1-185"></a>    IBKR_TESTING_PORT <span class="op">=</span> <span class="dv">4002</span></span>
<span id="cb1-186"><a href="#cb1-186"></a>    IBKR_LIVE_PORT <span class="op">=</span> <span class="dv">4001</span></span>
<span id="cb1-187"><a href="#cb1-187"></a></span>
<span id="cb1-188"><a href="#cb1-188"></a>    LIVE_DATA <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb1-189"><a href="#cb1-189"></a>    FROZEN_DATA <span class="op">=</span> <span class="dv">2</span> </span>
<span id="cb1-190"><a href="#cb1-190"></a>    DELAYED_DATA <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb1-191"><a href="#cb1-191"></a>    FROZEN_DELAYED_DATA <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb1-192"><a href="#cb1-192"></a></span>
<span id="cb1-193"><a href="#cb1-193"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, address, port, client_id):</span>
<span id="cb1-194"><a href="#cb1-194"></a>        <span class="bu">print</span>(<span class="st">"Getting started with IBKR..."</span>)</span>
<span id="cb1-195"><a href="#cb1-195"></a>        EClient.<span class="fu">__init__</span>(<span class="va">self</span>, <span class="va">self</span>)</span>
<span id="cb1-196"><a href="#cb1-196"></a>        EWrapper.<span class="fu">__init__</span>(<span class="va">self</span>)</span>
<span id="cb1-197"><a href="#cb1-197"></a>                </span>
<span id="cb1-198"><a href="#cb1-198"></a>        <span class="co"># Establish the connection to TWS/IB Gateway</span></span>
<span id="cb1-199"><a href="#cb1-199"></a>        <span class="co"># TWS supports up to 32 simultaneous client connections</span></span>
<span id="cb1-200"><a href="#cb1-200"></a>        <span class="va">self</span>.<span class="ex">connect</span>(address, port, client_id)</span>
<span id="cb1-201"><a href="#cb1-201"></a>        <span class="va">self</span>.connected <span class="op">=</span> <span class="va">True</span></span>
<span id="cb1-202"><a href="#cb1-202"></a>        <span class="va">self</span>.positions <span class="op">=</span> []</span>
<span id="cb1-203"><a href="#cb1-203"></a>        <span class="va">self</span>.open_orders <span class="op">=</span> []</span>
<span id="cb1-204"><a href="#cb1-204"></a></span>
<span id="cb1-205"><a href="#cb1-205"></a>        <span class="co"># Launch the client thread</span></span>
<span id="cb1-206"><a href="#cb1-206"></a>        <span class="co"># The 'run' function executes in a loop that repeats as long</span></span>
<span id="cb1-207"><a href="#cb1-207"></a>        <span class="co"># as the client is connected.</span></span>
<span id="cb1-208"><a href="#cb1-208"></a>        thread <span class="op">=</span> threading.Thread(target <span class="op">=</span> <span class="va">self</span>.run)</span>
<span id="cb1-209"><a href="#cb1-209"></a>        thread.start()</span>
<span id="cb1-210"><a href="#cb1-210"></a></span>
<span id="cb1-211"><a href="#cb1-211"></a>    <span class="at">@iswrapper</span></span>
<span id="cb1-212"><a href="#cb1-212"></a>    <span class="kw">def</span> nextValidId(<span class="va">self</span>, orderId):</span>
<span id="cb1-213"><a href="#cb1-213"></a>        <span class="va">self</span>.orderId <span class="op">=</span> orderId</span>
<span id="cb1-214"><a href="#cb1-214"></a></span>
<span id="cb1-215"><a href="#cb1-215"></a>    <span class="at">@iswrapper</span></span>
<span id="cb1-216"><a href="#cb1-216"></a>    <span class="kw">def</span> nextId(<span class="va">self</span>):</span>
<span id="cb1-217"><a href="#cb1-217"></a>        <span class="va">self</span>.orderId <span class="op">+=</span> <span class="dv">1</span> </span>
<span id="cb1-218"><a href="#cb1-218"></a>        <span class="cf">return</span> <span class="va">self</span>.orderId</span>
<span id="cb1-219"><a href="#cb1-219"></a>    </span>
<span id="cb1-220"><a href="#cb1-220"></a>    <span class="at">@iswrapper</span></span>
<span id="cb1-221"><a href="#cb1-221"></a>    <span class="kw">def</span> currentTime(<span class="va">self</span>, current_time):</span>
<span id="cb1-222"><a href="#cb1-222"></a>        t <span class="op">=</span> datetime.datetime.fromtimestamp(current_time)</span>
<span id="cb1-223"><a href="#cb1-223"></a>        <span class="bu">print</span>(<span class="ss">f'Current time: </span><span class="sc">{</span> t <span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb1-224"><a href="#cb1-224"></a></span>
<span id="cb1-225"><a href="#cb1-225"></a>    <span class="at">@iswrapper</span></span>
<span id="cb1-226"><a href="#cb1-226"></a>    <span class="kw">def</span> contractDetails(<span class="va">self</span>, request_id, contractDetails):</span>
<span id="cb1-227"><a href="#cb1-227"></a>        attrs <span class="op">=</span> <span class="bu">vars</span>(contractDetails)</span>
<span id="cb1-228"><a href="#cb1-228"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span>.join(<span class="ss">f"</span><span class="sc">{</span> name <span class="sc">}</span><span class="ss">: </span><span class="sc">{</span> value <span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> name, value <span class="kw">in</span> attrs.items()))</span>
<span id="cb1-229"><a href="#cb1-229"></a></span>
<span id="cb1-230"><a href="#cb1-230"></a>    <span class="at">@iswrapper</span></span>
<span id="cb1-231"><a href="#cb1-231"></a>    <span class="kw">def</span> contractDetailsEnd(<span class="va">self</span>, reqId):</span>
<span id="cb1-232"><a href="#cb1-232"></a>        <span class="cf">return</span> <span class="bu">super</span>().contractDetailsEnd(reqId)</span>
<span id="cb1-233"><a href="#cb1-233"></a></span>
<span id="cb1-234"><a href="#cb1-234"></a>    <span class="at">@iswrapper</span></span>
<span id="cb1-235"><a href="#cb1-235"></a>    <span class="kw">def</span> historicalData(<span class="va">self</span>, request_id, bar):</span>
<span id="cb1-236"><a href="#cb1-236"></a>        <span class="bu">print</span>(bar)</span>
<span id="cb1-237"><a href="#cb1-237"></a>        <span class="cf">return</span> <span class="bu">super</span>().historicalData(request_id, bar)</span>
<span id="cb1-238"><a href="#cb1-238"></a>    </span>
<span id="cb1-239"><a href="#cb1-239"></a>    <span class="at">@iswrapper</span></span>
<span id="cb1-240"><a href="#cb1-240"></a>    <span class="kw">def</span> historicalDataEnd(<span class="va">self</span>, reqId, start, end):</span>
<span id="cb1-241"><a href="#cb1-241"></a>        <span class="bu">print</span>(<span class="ss">f"Historical data ended for </span><span class="sc">{</span> reqId <span class="sc">}</span><span class="ss">. Started at </span><span class="sc">{</span> start <span class="sc">}</span><span class="ss">, ending at </span><span class="sc">{</span> end <span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-242"><a href="#cb1-242"></a>        <span class="cf">return</span> <span class="bu">super</span>().historicalDataEnd(reqId, start, end)</span>
<span id="cb1-243"><a href="#cb1-243"></a></span>
<span id="cb1-244"><a href="#cb1-244"></a>    <span class="at">@iswrapper</span></span>
<span id="cb1-245"><a href="#cb1-245"></a>    <span class="kw">def</span> error(<span class="va">self</span>, reqId, errorCode, errorString, advancedOrderRejectJson <span class="op">=</span> <span class="st">""</span>):</span>
<span id="cb1-246"><a href="#cb1-246"></a>        <span class="bu">print</span>(<span class="ss">f'Error: </span><span class="sc">{</span> errorCode <span class="sc">}</span><span class="ss">: </span><span class="sc">{</span> errorString <span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb1-247"><a href="#cb1-247"></a>        <span class="cf">return</span> <span class="bu">super</span>().error(reqId, errorCode, errorString, advancedOrderRejectJson)</span>
<span id="cb1-248"><a href="#cb1-248"></a>    </span>
<span id="cb1-249"><a href="#cb1-249"></a>    <span class="at">@iswrapper</span></span>
<span id="cb1-250"><a href="#cb1-250"></a>    <span class="kw">def</span> tickPrice(<span class="va">self</span>, reqId, tickType, price, attrib):</span>
<span id="cb1-251"><a href="#cb1-251"></a>        <span class="bu">print</span>(<span class="ss">f"Request ID: </span><span class="sc">{</span> reqId <span class="sc">}</span><span class="ss">, tickType: </span><span class="sc">{</span> TickTypeEnum<span class="sc">.</span>to_str(tickType) <span class="sc">}</span><span class="ss">, price: </span><span class="sc">{</span> price <span class="sc">}</span><span class="ss">, attrib: </span><span class="sc">{</span> attrib <span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-252"><a href="#cb1-252"></a></span>
<span id="cb1-253"><a href="#cb1-253"></a>    <span class="at">@iswrapper</span></span>
<span id="cb1-254"><a href="#cb1-254"></a>    <span class="kw">def</span> tickSize(<span class="va">self</span>, reqId, tickType, size):</span>
<span id="cb1-255"><a href="#cb1-255"></a>        <span class="bu">print</span>(<span class="ss">f"Request ID: </span><span class="sc">{</span> reqId <span class="sc">}</span><span class="ss">, tickType: </span><span class="sc">{</span> TickTypeEnum<span class="sc">.</span>to_str(tickType)<span class="sc">}</span><span class="ss">, size: </span><span class="sc">{</span> size <span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-256"><a href="#cb1-256"></a></span>
<span id="cb1-257"><a href="#cb1-257"></a>    <span class="at">@iswrapper</span></span>
<span id="cb1-258"><a href="#cb1-258"></a>    <span class="kw">def</span> tickString(<span class="va">self</span>, request_id, tickType, value):</span>
<span id="cb1-259"><a href="#cb1-259"></a>        <span class="bu">print</span>(<span class="ss">f"Request ID: </span><span class="sc">{</span> request_id <span class="sc">}</span><span class="ss">, tickType: </span><span class="sc">{</span> TickTypeEnum<span class="sc">.</span>to_str(tickType) <span class="sc">}</span><span class="ss">, value: </span><span class="sc">{</span> value <span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-260"><a href="#cb1-260"></a></span>
<span id="cb1-261"><a href="#cb1-261"></a>    <span class="at">@iswrapper</span></span>
<span id="cb1-262"><a href="#cb1-262"></a>    <span class="kw">def</span> accountSummary(<span class="va">self</span>, reqId, account, tag, value, currency):</span>
<span id="cb1-263"><a href="#cb1-263"></a>        <span class="cf">return</span> <span class="bu">super</span>().accountSummary(reqId, account, tag, value, currency)</span>
<span id="cb1-264"><a href="#cb1-264"></a>    </span>
<span id="cb1-265"><a href="#cb1-265"></a>    <span class="at">@iswrapper</span></span>
<span id="cb1-266"><a href="#cb1-266"></a>    <span class="kw">def</span> updatePortfolio(<span class="va">self</span>, contract: Contract, position: <span class="bu">float</span>, marketPrice: <span class="bu">float</span>, marketValue: <span class="bu">float</span>, averageCost: <span class="bu">float</span>, unrealizedPNL: <span class="bu">float</span>, realizedPNL: <span class="bu">float</span>, accountName: <span class="bu">str</span>):</span>
<span id="cb1-267"><a href="#cb1-267"></a>        <span class="bu">print</span>(<span class="st">"UpdatePortfolio."</span>, <span class="st">"Symbol:"</span>, contract.symbol, <span class="st">"SecType:"</span>, contract.secType, <span class="st">"Exchange:"</span>, contract.exchange, <span class="st">"Position:"</span>, position, <span class="st">"MarketPrice:"</span>, marketPrice, <span class="st">"MarketValue:"</span>, marketValue, <span class="st">"AverageCost:"</span>, averageCost, <span class="st">"UnrealizedPNL:"</span>, unrealizedPNL, <span class="st">"RealizedPNL:"</span>, realizedPNL, <span class="st">"AccountName:"</span>, accountName)</span>
<span id="cb1-268"><a href="#cb1-268"></a>        </span>
<span id="cb1-269"><a href="#cb1-269"></a>    <span class="at">@iswrapper</span></span>
<span id="cb1-270"><a href="#cb1-270"></a>    <span class="kw">def</span> updateAccountTime(<span class="va">self</span>, timeStamp: <span class="bu">str</span>):</span>
<span id="cb1-271"><a href="#cb1-271"></a>        <span class="bu">print</span>(<span class="st">"UpdateAccountTime. Time:"</span>, timeStamp)</span>
<span id="cb1-272"><a href="#cb1-272"></a></span>
<span id="cb1-273"><a href="#cb1-273"></a>    <span class="at">@iswrapper</span></span>
<span id="cb1-274"><a href="#cb1-274"></a>    <span class="kw">def</span> updateAccountValue(<span class="va">self</span>, key: <span class="bu">str</span>, val: <span class="bu">str</span>, currency: <span class="bu">str</span>, accountName: <span class="bu">str</span>):</span>
<span id="cb1-275"><a href="#cb1-275"></a>        <span class="bu">print</span>(<span class="st">"UpdateAccountValue. Key:"</span>, key, <span class="st">"Value:"</span>, val, <span class="st">"Currency:"</span>, currency, <span class="st">"AccountName:"</span>, accountName)</span>
<span id="cb1-276"><a href="#cb1-276"></a></span>
<span id="cb1-277"><a href="#cb1-277"></a>    <span class="at">@iswrapper</span></span>
<span id="cb1-278"><a href="#cb1-278"></a>    <span class="kw">def</span> position(<span class="va">self</span>, account: <span class="bu">str</span>, contract: Contract, position: Decimal, avgCost: <span class="bu">float</span>):</span>
<span id="cb1-279"><a href="#cb1-279"></a>        <span class="va">self</span>.positions.append([contract, position, avgCost])</span>
<span id="cb1-280"><a href="#cb1-280"></a>        <span class="bu">print</span>(<span class="st">"Position."</span>, <span class="st">"Account:"</span>, account, <span class="st">"Contract:"</span>, contract, <span class="st">"Position:"</span>, position, <span class="st">"Avg cost:"</span>, avgCost)</span>
<span id="cb1-281"><a href="#cb1-281"></a>        </span>
<span id="cb1-282"><a href="#cb1-282"></a>    <span class="kw">def</span> positionEnd(<span class="va">self</span>):</span>
<span id="cb1-283"><a href="#cb1-283"></a>       <span class="bu">print</span>(<span class="st">"PositionEnd"</span>)</span>
<span id="cb1-284"><a href="#cb1-284"></a></span>
<span id="cb1-285"><a href="#cb1-285"></a>    <span class="kw">def</span> orderStatus(<span class="va">self</span>, orderId: OrderId, status: <span class="bu">str</span>, filled: Decimal, remaining: Decimal, avgFillPrice: <span class="bu">float</span>, permId: <span class="bu">int</span>, parentId: <span class="bu">int</span>, lastFillPrice: <span class="bu">float</span>, clientId: <span class="bu">int</span>, whyHeld: <span class="bu">str</span>, mktCapPrice: <span class="bu">float</span>):</span>
<span id="cb1-286"><a href="#cb1-286"></a>        <span class="bu">print</span>(<span class="st">"OrderStatus. Id:"</span>, orderId, <span class="st">"Status:"</span>, status, <span class="st">"Filled:"</span>, decimalMaxString(filled), <span class="st">"Remaining:"</span>, decimalMaxString(remaining), <span class="st">"AvgFillPrice:"</span>, floatMaxString(avgFillPrice), <span class="st">"PermId:"</span>, intMaxString(permId), <span class="st">"ParentId:"</span>, intMaxString(parentId), <span class="st">"LastFillPrice:"</span>, floatMaxString(lastFillPrice), <span class="st">"ClientId:"</span>, intMaxString(clientId), <span class="st">"WhyHeld:"</span>, whyHeld, <span class="st">"MktCapPrice:"</span>, floatMaxString(mktCapPrice))</span>
<span id="cb1-287"><a href="#cb1-287"></a></span>
<span id="cb1-288"><a href="#cb1-288"></a>    <span class="kw">def</span> openOrderEnd(<span class="va">self</span>):</span>
<span id="cb1-289"><a href="#cb1-289"></a>        <span class="bu">print</span>(<span class="st">"OpenOrderEnd"</span>)</span>
<span id="cb1-290"><a href="#cb1-290"></a></span>
<span id="cb1-291"><a href="#cb1-291"></a></span>
<span id="cb1-292"><a href="#cb1-292"></a>    <span class="at">@iswrapper</span></span>
<span id="cb1-293"><a href="#cb1-293"></a>    <span class="kw">def</span> get_positions(<span class="va">self</span>):</span>
<span id="cb1-294"><a href="#cb1-294"></a>        <span class="co"># Get all current positions from an account</span></span>
<span id="cb1-295"><a href="#cb1-295"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="va">self</span>.connected:</span>
<span id="cb1-296"><a href="#cb1-296"></a>            <span class="bu">print</span>(<span class="st">"Error: You're not connected to IBKR ..."</span>)</span>
<span id="cb1-297"><a href="#cb1-297"></a>            <span class="cf">return</span> []</span>
<span id="cb1-298"><a href="#cb1-298"></a>        </span>
<span id="cb1-299"><a href="#cb1-299"></a>        positions <span class="op">=</span> <span class="va">self</span>.positions()</span>
<span id="cb1-300"><a href="#cb1-300"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Found </span><span class="sc">{</span> <span class="bu">len</span>(positions) <span class="sc">}</span><span class="ss"> open positions"</span>)</span>
<span id="cb1-301"><a href="#cb1-301"></a>        </span>
<span id="cb1-302"><a href="#cb1-302"></a>        <span class="cf">for</span> pos <span class="kw">in</span> positions:</span>
<span id="cb1-303"><a href="#cb1-303"></a>            <span class="bu">print</span>(<span class="ss">f"  • </span><span class="sc">{</span>pos<span class="sc">.</span>contract<span class="sc">.</span>symbol<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span> pos<span class="sc">.</span>position<span class="sc">}</span><span class="ss"> contracts @ $</span><span class="sc">{</span> pos<span class="sc">.</span>avgCost<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb1-304"><a href="#cb1-304"></a>        </span>
<span id="cb1-305"><a href="#cb1-305"></a>        <span class="cf">return</span> positions</span>
<span id="cb1-306"><a href="#cb1-306"></a></span>
<span id="cb1-307"><a href="#cb1-307"></a>    <span class="co"># Order-related wrappers</span></span>
<span id="cb1-308"><a href="#cb1-308"></a>    <span class="at">@iswrapper</span></span>
<span id="cb1-309"><a href="#cb1-309"></a>    <span class="kw">def</span> openOrder(<span class="va">self</span>, orderId, contract, order, orderState):</span>
<span id="cb1-310"><a href="#cb1-310"></a>        <span class="va">self</span>.open_orders.append([orderId, contract, order, orderState])</span>
<span id="cb1-311"><a href="#cb1-311"></a></span>
<span id="cb1-312"><a href="#cb1-312"></a>        <span class="bu">print</span>(<span class="ss">f"Order ID: </span><span class="sc">{</span> orderId<span class="sc">}</span><span class="ss">, contract: </span><span class="sc">{</span> contract <span class="sc">}</span><span class="ss">, order: </span><span class="sc">{</span> order <span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-313"><a href="#cb1-313"></a>        <span class="cf">return</span> <span class="bu">super</span>().openOrder(orderId, contract, order, orderState)</span>
<span id="cb1-314"><a href="#cb1-314"></a>    </span>
<span id="cb1-315"><a href="#cb1-315"></a>    <span class="at">@iswrapper</span></span>
<span id="cb1-316"><a href="#cb1-316"></a>    <span class="kw">def</span> orderStatus(<span class="va">self</span>, orderId, status, filled, remaining, avgFillPrice, permId, parentId, lastFillPrice, clientId, whyHeld, mktCapPrice):</span>
<span id="cb1-317"><a href="#cb1-317"></a>        <span class="bu">print</span>(<span class="ss">f"Order ID: </span><span class="sc">{</span> orderId <span class="sc">}</span><span class="ss">, status: </span><span class="sc">{</span> status <span class="sc">}</span><span class="ss">, filled: </span><span class="sc">{</span> filled <span class="sc">}</span><span class="ss">, remaining: </span><span class="sc">{</span> remaining <span class="sc">}</span><span class="ss">, lastFillPrice: </span><span class="sc">{</span> lastFillPrice <span class="sc">}</span><span class="ss">, permID: </span><span class="sc">{</span> permId <span class="sc">}</span><span class="ss">, avgFillPrice: </span><span class="sc">{</span> avgFillPrice <span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-318"><a href="#cb1-318"></a>        <span class="cf">return</span> <span class="bu">super</span>().orderStatus(orderId, status, filled, remaining, avgFillPrice, permId, parentId, lastFillPrice, clientId, whyHeld, mktCapPrice)</span>
<span id="cb1-319"><a href="#cb1-319"></a>    </span>
<span id="cb1-320"><a href="#cb1-320"></a>    <span class="at">@iswrapper</span></span>
<span id="cb1-321"><a href="#cb1-321"></a>    <span class="kw">def</span> execDetails(<span class="va">self</span>, reqId, contract, execution):</span>
<span id="cb1-322"><a href="#cb1-322"></a>        <span class="bu">print</span>(<span class="ss">f"Execution details. Request ID: </span><span class="sc">{</span> reqId <span class="sc">}</span><span class="ss">, contract: </span><span class="sc">{</span> contract <span class="sc">}</span><span class="ss">, execution: </span><span class="sc">{</span> execution <span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-323"><a href="#cb1-323"></a>        <span class="cf">return</span> <span class="bu">super</span>().execDetails(reqId, contract, execution)</span>
<span id="cb1-324"><a href="#cb1-324"></a></span>
<span id="cb1-325"><a href="#cb1-325"></a><span class="kw">def</span> update_once(ibkr_client):</span>
<span id="cb1-326"><a href="#cb1-326"></a>    <span class="co"># Example: Connect to IBKR and update stops once</span></span>
<span id="cb1-327"><a href="#cb1-327"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb1-328"><a href="#cb1-328"></a>    <span class="bu">print</span>(<span class="st">"One-Time Stop Update"</span>)</span>
<span id="cb1-329"><a href="#cb1-329"></a>    <span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb1-330"><a href="#cb1-330"></a>    </span>
<span id="cb1-331"><a href="#cb1-331"></a>    <span class="cf">try</span>:</span>
<span id="cb1-332"><a href="#cb1-332"></a>        ibkr_account <span class="op">=</span> os.getenv(<span class="st">"IBKR_ACCOUNT_ID"</span>) </span>
<span id="cb1-333"><a href="#cb1-333"></a>        manager <span class="op">=</span> ChandelierStopManager(ibkr_client <span class="op">=</span> ibkr_client, ibkr_account <span class="op">=</span> ibkr_account)</span>
<span id="cb1-334"><a href="#cb1-334"></a>        manager.update_stops_for_all_positions(multiplier <span class="op">=</span> ATR_MULTIPLIER)</span>
<span id="cb1-335"><a href="#cb1-335"></a>    <span class="cf">except</span> <span class="pp">KeyError</span>:</span>
<span id="cb1-336"><a href="#cb1-336"></a>        <span class="bu">print</span>(<span class="st">"Yikes! No IBKR account ID available..."</span>)</span>
<span id="cb1-337"><a href="#cb1-337"></a></span>
<span id="cb1-338"><a href="#cb1-338"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb1-339"><a href="#cb1-339"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb1-340"><a href="#cb1-340"></a>    <span class="bu">print</span>(<span class="st">"CHANDELIER STOP SYSTEM ..."</span>)</span>
<span id="cb1-341"><a href="#cb1-341"></a>    <span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb1-342"><a href="#cb1-342"></a></span>
<span id="cb1-343"><a href="#cb1-343"></a>    <span class="co"># Connect to Interactive Brokers API via IB Gateway (v10.37 in this case...)</span></span>
<span id="cb1-344"><a href="#cb1-344"></a>    ib_client <span class="op">=</span> IBApiClient(IBApiClient.IBKR_GATEWAY_ADDRESS, IBApiClient.IBKR_TESTING_PORT, <span class="dv">10252025</span>)</span>
<span id="cb1-345"><a href="#cb1-345"></a>    </span>
<span id="cb1-346"><a href="#cb1-346"></a>    time.sleep(<span class="dv">7</span>)</span>
<span id="cb1-347"><a href="#cb1-347"></a></span>
<span id="cb1-348"><a href="#cb1-348"></a>    update_once(ib_client)</span>
<span id="cb1-349"><a href="#cb1-349"></a>    </span></code></pre></div>
</div>
<p>And when it runs, this is what you get! This run is based on my paper trading account with an existing <code>SPY</code> position (shares, not options) I bought when it was at $540.59-ish.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="chandelier-output-1.png" class="img-fluid figure-img"></p>
<figcaption>Chandelier stop paper trading account run</figcaption>
</figure>
</div>
</section>
<section id="whats-next" class="level3">
<h3 class="anchored" data-anchor-id="whats-next">What’s next?</h3>
<p>Elder himself admits that the “…negative side of Chandelier Exits is that they give up a great deal of profit. Three Average True Ranges can amount to a lot of money in a volatile market.” He recommends experimenting with the Average True Range coefficient (<code>ATR_MULTIPLIER</code> in my code).</p>
<p>The code listed here does not include the portion that takes a volatility and calculates the option price to set a stop. I will update with that soon.</p>
<p>Finally, some of this code could be cleaned up. The Interactive Brokers API callback methods are mostly from their developer documentation.</p>
</section>
<section id="an-update" class="level3">
<h3 class="anchored" data-anchor-id="an-update">An update</h3>
<p>Funny enough, this stop triggered right at opening on November 7 after a bad Michigan consumer sentiment reading and tech stock sell-offs. <code>SPY</code> slid to a low of $661.21 after this triggered. There probably could be some work around giving these stops a bit more breathing room (<code>SPY</code> only had to move 0.2% to the downside to trigger it which could easily come from opening volatility some days), but this was still great to see it activate and see <code>SPY</code> continue to fall after this stop was activated, preserving (paper) funds. That really illustrates the power of stops (ignoring stop hunters and quick bouncebacks which could be dealt with by more breating room, etc.).</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/tiffani\.dev\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>